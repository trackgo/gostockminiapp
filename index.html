<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Telegram Mini App</title>
    
    <!-- This is the official Telegram Web App SDK -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- We'll use Tailwind CSS for easy, clean styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* A little extra style for smooth transitions and a better look */
        body, button, input, select {
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }
        .tab-button.active {
            border-bottom-width: 2px;
        }
        .view {
            display: none;
        }
        .view.active {
            display: block;
        }
    </style>
</head>
<body class="font-sans">

    <div id="mainContainer" class="max-w-lg mx-auto">
        <!-- Header & Navigation -->
        <header class="p-4 sticky top-0 z-10 backdrop-blur-md">
            <nav class="flex justify-around border-b">
                <button id="homeTab" class="tab-button flex-1 py-2 text-center font-semibold">Home</button>
                <button id="expensesTab" class="tab-button flex-1 py-2 text-center font-semibold">Expenses</button>
                <button id="invoicesTab" class="tab-button flex-1 py-2 text-center font-semibold">Invoices</button>
            </nav>
        </header>

        <main class="p-4">
            <!-- Home View -->
            <div id="homeView" class="view">
                <div class="text-center mb-6">
                    <h1 class="text-3xl font-bold">Welcome!</h1>
                    <p class="text-sm">This is your enhanced Telegram Mini App.</p>
                </div>
                <div id="userInfo" class="bg-white/50 backdrop-blur-sm rounded-xl shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-3">User Information</h2>
                    <div id="userInfoContent" class="space-y-2">
                        <p>Loading data from Telegram...</p>
                    </div>
                </div>
            </div>

            <!-- Expenses View -->
            <div id="expensesView" class="view">
                <h2 class="text-2xl font-bold mb-4 text-center">Expense Tracker</h2>
                <!-- Add Expense Form -->
                <form id="expenseForm" class="bg-white/50 backdrop-blur-sm rounded-xl shadow-md p-6 mb-6 space-y-4">
                    <h3 class="text-lg font-semibold">Add New Expense</h3>
                    <div>
                        <label for="expenseName" class="block text-sm font-medium">Expense Name</label>
                        <input type="text" id="expenseName" name="expenseName" required class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-1 sm:text-sm">
                    </div>
                    <div>
                        <label for="amount" class="block text-sm font-medium">Amount</label>
                        <input type="number" id="amount" name="amount" step="0.01" required class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-1 sm:text-sm">
                    </div>
                    <div>
                        <label for="currency" class="block text-sm font-medium">Currency</label>
                        <select id="currency" name="currency" class="mt-1 block w-full px-3 py-2 border rounded-md shadow-sm focus:outline-none focus:ring-1 sm:text-sm">
                            <option value="KHR">KHR (៛)</option>
                            <option value="USD">USD ($)</option>
                        </select>
                    </div>
                    <button type="submit" id="addExpenseBtn" class="w-full text-white font-bold py-2 px-4 rounded-lg shadow-lg">Add Expense</button>
                </form>
                <!-- Expense Table -->
                <div class="bg-white/50 backdrop-blur-sm rounded-xl shadow-md p-6">
                     <h3 class="text-lg font-semibold mb-2">Expense List</h3>
                     <div class="overflow-x-auto">
                        <table id="expenseTable" class="min-w-full text-sm text-left">
                            <thead class="border-b font-medium">
                                <tr>
                                    <th class="px-4 py-2">Name</th>
                                    <th class="px-4 py-2">KHR</th>
                                    <th class="px-4 py-2">USD</th>
                                    <th class="px-4 py-2">Date</th>
                                </tr>
                            </thead>
                            <tbody id="expenseTableBody">
                                <!-- Expense rows will be inserted here -->
                            </tbody>
                        </table>
                     </div>
                </div>
            </div>

            <!-- Invoices View -->
            <div id="invoicesView" class="view">
                <h2 class="text-2xl font-bold mb-4 text-center">Invoice Creator</h2>
                <div class="bg-white/50 backdrop-blur-sm rounded-xl shadow-md p-8 text-center">
                    <p class="mb-4">Click the button below to generate a new invoice. This will open a confirmation dialog.</p>
                    <button id="createInvoiceBtn" class="w-full text-white font-bold py-3 px-4 rounded-lg shadow-lg">Create New Invoice</button>
                </div>
            </div>
        </main>
    </div>

    <!-- Error message for when not running in Telegram -->
    <div id="errorContainer" class="hidden text-center p-8">
        <h1 class="text-2xl font-bold text-red-600 mb-2">Error</h1>
        <p class="text-gray-700">This web application is designed to be run as a <a href="https://core.telegram.org/bots/webapps" class="text-blue-500 underline">Telegram Mini App</a>.</p>
        <p class="text-gray-500 mt-4">Please open it through a Telegram bot.</p>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // The main object for interacting with the Telegram client
            const tg = window.Telegram.WebApp;

            // --- DOM ELEMENTS ---
            const mainContainer = document.getElementById('mainContainer');
            const errorContainer = document.getElementById('errorContainer');
            const views = document.querySelectorAll('.view');
            const tabs = document.querySelectorAll('.tab-button');

            // --- APP STATE ---
            let expenses = [];
            const KHR_TO_USD_RATE = 4100; // Approximate rate

            // --- CHECK IF IN TELEGRAM ---
            if (tg.initDataUnsafe.user === undefined) {
                mainContainer.classList.add('hidden');
                errorContainer.classList.remove('hidden');
                document.body.classList.add('bg-gray-100');
                return; // Stop execution if not in Telegram
            }

            // --- 1. INITIALIZE THE APP ---
            tg.ready();
            tg.expand();

            // --- 2. THEME HANDLING ---
            const applyTheme = () => {
                const theme = tg.themeParams;
                const body = document.body;
                
                // Set body colors
                body.style.backgroundColor = theme.bg_color || '#ffffff';
                body.style.color = theme.text_color || '#000000';

                // Set button colors
                const buttons = document.querySelectorAll('#addExpenseBtn, #createInvoiceBtn');
                buttons.forEach(btn => {
                    btn.style.backgroundColor = theme.button_color || '#3390ec';
                    btn.style.color = theme.button_text_color || '#ffffff';
                });
                
                // Set tab active border color
                tabs.forEach(tab => {
                    tab.style.borderColor = theme.button_color || '#3390ec';
                });
            };
            applyTheme();
            tg.onEvent('themeChanged', applyTheme);

            // --- 3. NAVIGATION LOGIC ---
            const showView = (viewId) => {
                views.forEach(view => view.classList.remove('active'));
                tabs.forEach(tab => tab.classList.remove('active'));
                
                document.getElementById(viewId).classList.add('active');
                document.getElementById(viewId.replace('View', 'Tab')).classList.add('active');
            };

            tabs.forEach(tab => {
                tab.addEventListener('click', () => showView(tab.id.replace('Tab', 'View')));
            });

            // --- 4. DISPLAY USER DATA (HOME VIEW) ---
            const userInfoContent = document.getElementById('userInfoContent');
            const user = tg.initDataUnsafe.user;
            if (user) {
                userInfoContent.innerHTML = `
                    <p><strong>First Name:</strong> ${user.first_name || 'N/A'}</p>
                    <p><strong>Username:</strong> ${user.username ? '@' + user.username : 'N/A'}</p>
                    <p><strong>ID:</strong> ${user.id}</p>
                `;
            }

            // --- 5. EXPENSE TRACKER LOGIC ---
            const expenseForm = document.getElementById('expenseForm');
            const expenseTableBody = document.getElementById('expenseTableBody');

            const renderExpenses = () => {
                expenseTableBody.innerHTML = ''; // Clear existing rows
                if (expenses.length === 0) {
                    expenseTableBody.innerHTML = `<tr><td colspan="4" class="text-center p-4">No expenses added yet.</td></tr>`;
                } else {
                    expenses.forEach(exp => {
                        const row = document.createElement('tr');
                        row.className = 'border-b';
                        row.innerHTML = `
                            <td class="px-4 py-2">${exp.name}</td>
                            <td class="px-4 py-2">${exp.khr.toFixed(2)} ៛</td>
                            <td class="px-4 py-2">$${exp.usd.toFixed(2)}</td>
                            <td class="px-4 py-2">${exp.date}</td>
                        `;
                        expenseTableBody.appendChild(row);
                    });
                }
            };

            expenseForm.addEventListener('submit', function (event) {
                event.preventDefault();
                const name = document.getElementById('expenseName').value;
                const amount = parseFloat(document.getElementById('amount').value);
                const currency = document.getElementById('currency').value;

                let khr, usd;
                if (currency === 'USD') {
                    usd = amount;
                    khr = amount * KHR_TO_USD_RATE;
                } else {
                    khr = amount;
                    usd = amount / KHR_TO_USD_RATE;
                }
                
                const newExpense = {
                    name,
                    khr,
                    usd,
                    date: new Date().toLocaleDateString()
                };

                expenses.push(newExpense);
                renderExpenses();
                expenseForm.reset();
            });


            // --- 6. INVOICE CREATOR LOGIC ---
            document.getElementById('createInvoiceBtn').addEventListener('click', () => {
                tg.showConfirm("Are you sure you want to create a new invoice?", (confirmed) => {
                    if (confirmed) {
                        tg.showAlert("Invoice created successfully!");
                    }
                });
            });

            // --- 7. MAIN BUTTON CONFIGURATION ---
            tg.MainButton.setText("Close Mini App");
            tg.MainButton.show();
            tg.MainButton.onClick(() => tg.close());

            // --- INITIALIZE VIEW ---
            showView('homeView');
            renderExpenses(); // Initial render for the expense table
        });
    </script>
</body>
</html>
